# Instead of using artifacts, just build in an NFS-mounted directory,
# $BUILD_DIR, that's unique to each pipeline in case there are concurrent
# pipelines.  Why not use artifacts?
#
# - [The following numbers are a bit old, and they were recorded for a debug
#   build.]
# - LLVM's build directory is huge.  For me, it's 46G when including just
#   the clang and openmp subprojects, which are required for Clacc, and it's
#   85G when including nearly all subprojects.
# - At this size, it takes a long time to upload/download between stages and
#   can be rejected as an upload because of its size.  For me, it added 20
#   min to the already 30 min build of that 46G and then was rejected.
# - Artifacts are posted for download and stored long past when it's useful
#   for humans to download the LLVM build directory, which is typically
#   never.
# - We could squash the pipeline to one stage to avoid the need for
#   artifacts, but pipeline stages are a convenient way to view results when
#   debugging.
#
# The NFS solution used here is based on the following comment (which is in
# response to a proposal for a gitlab feature that would solve this
# problem):
#
#   https://gitlab.com/gitlab-org/gitlab/issues/29265#note_225288132
#
# However, because the NFS-mounted build directory name is different for each
# pipeline, ccache misses if we compile within it.  Thus, we set
# CCACHE_NOHASHDIR and CCACHE_BASEDIR (neither alone proves sufficient), as
# suggested by the ccache manual.  CCACHE_NOHASHDIR can lead to incorrect
# directory names in debugging symbols, but currently we don't expect those to
# matter to our CI builds.
variables:
  BUILD_DIR_PROJ: $CI_BUILDS_DIR/$CI_PROJECT_PATH_SLUG-builds
  BUILD_DIR: $CI_BUILDS_DIR/$CI_PROJECT_PATH_SLUG-builds/$CI_PIPELINE_ID-$BUILD_ID
  BUILD_DIRS: $CI_BUILDS_DIR/$CI_PROJECT_PATH_SLUG-builds/$CI_PIPELINE_ID-*
  LLVM_CCACHE_PARAMS: 'CCACHE_CPP2=yes CCACHE_NOHASHDIR=yes CCACHE_BASEDIR=$CI_BUILDS_DIR/$CI_PROJECT_PATH_SLUG-builds'
  LLVM_TARGETS_TO_BUILD: all
  CHECK_TARGETS: check-all
  # The number of tests launched at once is `nproc` / $LIT_NPROC_DIVISOR.
  LIT_NPROC_DIVISOR: 1
  # TODO: These tests expect runtime diagnostics that certain OMPT callbacks
  # cannot be registered.  That's true upstream, but Clacc enables those
  # callbacks, so the tests currently fail under Clacc.  For other offload
  # targets, upstream has marked the tests unsupported.  Eventually, upstream
  # will surely adjust the tests to expect successful registration, and it's
  # not clear the tests will necessarily become unexpected passes at that
  # point under Clacc, so we'll just have to remember to remove the following
  # at that time.
  TEST_CLACC_LIT_XFAIL:
    "
    libomptarget :: amdgcn-amd-amdhsa :: ompt/veccopy.c
    libomptarget :: amdgcn-amd-amdhsa :: ompt/veccopy_disallow_both.c
    libomptarget :: amdgcn-amd-amdhsa :: ompt/veccopy_emi.c
    libomptarget :: amdgcn-amd-amdhsa :: ompt/veccopy_emi_map.c
    libomptarget :: amdgcn-amd-amdhsa :: ompt/veccopy_map.c
    libomptarget :: amdgcn-amd-amdhsa :: ompt/veccopy_wrong_return.c
    libomptarget :: powerpc64le-ibm-linux-gnu :: ompt/veccopy.c
    libomptarget :: powerpc64le-ibm-linux-gnu :: ompt/veccopy_disallow_both.c
    libomptarget :: powerpc64le-ibm-linux-gnu :: ompt/veccopy_emi.c
    libomptarget :: powerpc64le-ibm-linux-gnu :: ompt/veccopy_emi_map.c
    libomptarget :: powerpc64le-ibm-linux-gnu :: ompt/veccopy_map.c
    libomptarget :: powerpc64le-ibm-linux-gnu :: ompt/veccopy_wrong_return.c
    libomptarget :: powerpc64le-ibm-linux-gnu-LTO :: ompt/veccopy.c
    libomptarget :: powerpc64le-ibm-linux-gnu-LTO :: ompt/veccopy_disallow_both.c
    libomptarget :: powerpc64le-ibm-linux-gnu-LTO :: ompt/veccopy_emi.c
    libomptarget :: powerpc64le-ibm-linux-gnu-LTO :: ompt/veccopy_emi_map.c
    libomptarget :: powerpc64le-ibm-linux-gnu-LTO :: ompt/veccopy_map.c
    libomptarget :: powerpc64le-ibm-linux-gnu-LTO :: ompt/veccopy_wrong_return.c
    "
  # Which commits and options to use for OpenACC V&V testing.
  VV_LLVM_TEST_SUITE_COMMIT: da5c250df731c259bd6f15f05ab93f3f7b902b63
  VV_COMMIT: 5ba1bbcdebc63237e650fa2fbf7a5e0781f6d724
  VV_CFLAGS:
  # Which commits and options to use for Kokkos testing.
  KOKKOS_COMMIT: c0b44471a15185cb0831705502349c58abf8677d
  KOKKOS_TESTS_COMMIT: 02f9f3bace5f12388a1d921c67a2ed98f37b2323
  KOKKOS_CMAKE_OPTS:
  KOKKOS_CFLAGS:

stages:
  - setup
  - config
  - build
  - test
  - vv
  - kokkos
  - cleanup
  - manual cleanup

#-------------------------------------------------------------------------------
# build configurations
#
# - Sometimes enabling assertions breaks builds/tests (assertion fails).
#   Sometimes disabling them does (assertion has required side effect).
#   Assertions can be architecture-specific, so check every architecture both
#   ways.
# - Check every architecture with a release build, which is faster and takes
#   much less disk space than a debug build.
# - There are multiple milan* systems, so use them to check the case of a debug
#   build.
#-------------------------------------------------------------------------------

# leconte has a /usr/lib64/libomptarget.so that, at least since July, 2022,
# LLVM/Clang OpenMP support wants to pick up instead of the libomptarget.so
# built for it.  That breaks most tests in the libomptarget and OpenACC test
# suites unless we add -L$BUILD_DIR/build/lib in their lit configs.  In the case
# of libomptarget, we do this via OPENMP_TEST_FLAGS below until the direct lit
# config fix is upstreamed.  In the case of OpenACC, we modified the lit config
# directly.
#
# Below, we add -L$BUILD_DIR/install/lib when building the OpenACC V&V suite and
# Kokkos using the LLVM install, or they break similarly.  Obviously, it would
# be better for users if Clang's OpenMP support could work from its own install
# directory without being reminded where it is.  Hopefully that will be sorted
# out upstream one day.
.leconte:
  tags: [shell, leconte]
  variables:
    BUILD_ID: leconte
    MODULES: git cmake/3.19.2 gnu/9.2.0 nvhpc/22.11
    PATH_PREPEND:
      /opt/nvidia/hpc_sdk/Linux_ppc64le/22.11/cuda/11.8/bin
    CUDA_PATH: # used by Kokkos build
      /opt/nvidia/hpc_sdk/Linux_ppc64le/22.11/cuda/11.8
    CMAKE: cmake
    NINJA: ninja
    PYTHON: /usr/bin/python3
    CMAKE_BUILD_OPTS:
      -DCMAKE_BUILD_TYPE=Release
      -DOPENMP_TEST_FLAGS=-L$BUILD_DIR/build/lib
    LLVM_ENABLE_PROJECTS: "clang"
    LLVM_ENABLE_RUNTIMES: "openmp"
    CPU_TRIPLE: "powerpc64le-ibm-linux-gnu"
    CPU_COUNT:  4
    GPU_TRIPLE: "nvptx64-nvidia-cuda"
    GPU_COUNT:  6
    VV_CFLAGS: -L$BUILD_DIR/install/lib
    KOKKOS_CMAKE_OPTS: -DKokkos_ARCH_VOLTA70=On
    KOKKOS_CFLAGS: -L$BUILD_DIR/install/lib
    LIT_NPROC_DIVISOR: 4
    TEST_LIT_XFAIL:
      "
      libomp :: env/kmp_set_dispatch_buf.c
      libomptarget :: nvptx64-nvidia-cuda :: mapping/target_has_device_addr.c
      libomptarget :: nvptx64-nvidia-cuda-LTO :: offloading/info.c
      libomptarget :: nvptx64-nvidia-cuda-LTO :: mapping/target_has_device_addr.c
      libomptarget :: powerpc64le-ibm-linux-gnu :: offloading/barrier_fence.c
      libomptarget :: powerpc64le-ibm-linux-gnu :: offloading/target_critical_region.cpp
      libomptarget :: powerpc64le-ibm-linux-gnu-LTO :: offloading/barrier_fence.c
      libomptarget :: powerpc64le-ibm-linux-gnu-LTO :: offloading/target_critical_region.cpp
      "
    TEST_LIT_XFAIL_NOT:
      "
      libomptarget :: nvptx64-nvidia-cuda :: unified_shared_memory/api.c
      libomptarget :: nvptx64-nvidia-cuda-LTO :: unified_shared_memory/api.c
      "
    TEST_LIT_FILTER_OUT_LIST:
      "
      libomp :: worksharing/for/kmp_set_dispatch_buf.c
      libomptarget :: nvptx64-nvidia-cuda :: mapping/low_alignment.c
      libomptarget :: nvptx64-nvidia-cuda :: mapping/map_back_race.cpp
      libomptarget :: nvptx64-nvidia-cuda :: offloading/bug49334.cpp
      libomptarget :: nvptx64-nvidia-cuda-LTO :: mapping/low_alignment.c
      libomptarget :: nvptx64-nvidia-cuda-LTO :: offloading/bug49334.cpp
      libomptarget :: powerpc64le-ibm-linux-gnu :: offloading/bug49334.cpp
      libomptarget :: powerpc64le-ibm-linux-gnu :: mapping/low_alignment.c
      libomptarget :: powerpc64le-ibm-linux-gnu :: offloading/target_nowait_target.cpp
      libomptarget :: powerpc64le-ibm-linux-gnu-LTO :: mapping/low_alignment.c
      libomptarget :: powerpc64le-ibm-linux-gnu-LTO :: offloading/bug49334.cpp
      libomptarget :: powerpc64le-ibm-linux-gnu-LTO :: offloading/target_nowait_target.cpp
      "
    VV_COMP_LIT_XFAIL:
      ""
    VV_RUN_LIT_XFAIL:
      ""

.leconte-assert:
  extends: [.leconte]
  variables:
    BUILD_ID: leconte-assert
    CMAKE_BUILD_OPTS:
      -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_ASSERTIONS=True
      -DOPENMP_TEST_FLAGS=-L$BUILD_DIR/build/lib

.oswald:
  tags: [shell, oswald]
  variables:
    BUILD_ID: oswald
    MODULES: git cmake gnu/11.1.0 nvhpc/23.7
    PATH_PREPEND:
      /opt/nvidia/hpc_sdk/Linux_x86_64/23.7/cuda/12.2/bin
    CUDA_PATH: # used by Kokkos build
      /opt/nvidia/hpc_sdk/Linux_x86_64/23.7/cuda/12.2
    CMAKE: cmake
    NINJA: ninja
    PYTHON: /usr/bin/python3
    CMAKE_BUILD_OPTS: -DCMAKE_BUILD_TYPE=Release
    LLVM_ENABLE_PROJECTS: "clang"
    LLVM_ENABLE_RUNTIMES: "openmp"
    CPU_TRIPLE: "x86_64-pc-linux-gnu"
    CPU_COUNT:  4
    GPU_TRIPLE: "nvptx64-nvidia-cuda"
    GPU_COUNT:  1
    KOKKOS_CMAKE_OPTS: -DKokkos_ARCH_PASCAL60=On
    LIT_NPROC_DIVISOR: 1
    TEST_LIT_XFAIL:
      "
      libomptarget :: nvptx64-nvidia-cuda :: mapping/target_derefence_array_pointrs.cpp
      libomptarget :: nvptx64-nvidia-cuda :: mapping/target_has_device_addr.c
      libomptarget :: nvptx64-nvidia-cuda :: unified_shared_memory/close_enter_exit.c
      libomptarget :: nvptx64-nvidia-cuda :: unified_shared_memory/close_modifier.c
      libomptarget :: nvptx64-nvidia-cuda :: unified_shared_memory/shared_update.c
      libomptarget :: nvptx64-nvidia-cuda-LTO :: mapping/target_derefence_array_pointrs.cpp
      libomptarget :: nvptx64-nvidia-cuda-LTO :: mapping/target_has_device_addr.c
      libomptarget :: nvptx64-nvidia-cuda-LTO :: offloading/info.c
      libomptarget :: nvptx64-nvidia-cuda-LTO :: unified_shared_memory/close_enter_exit.c
      libomptarget :: nvptx64-nvidia-cuda-LTO :: unified_shared_memory/close_modifier.c
      libomptarget :: nvptx64-nvidia-cuda-LTO :: unified_shared_memory/shared_update.c
      ompd-test :: api_tests/test_ompd_finalize.c
      ompd-test :: api_tests/test_ompd_get_curr_parallel_handle.c
      "
    TEST_LIT_XFAIL_NOT:
      ""
    TEST_LIT_FILTER_OUT_LIST:
      "
      libomptarget :: nvptx64-nvidia-cuda :: mapping/map_back_race.cpp
      libomptarget :: nvptx64-nvidia-cuda :: offloading/bug47654.cpp
      libomptarget :: nvptx64-nvidia-cuda :: offloading/bug49334.cpp
      libomptarget :: nvptx64-nvidia-cuda :: offloading/bug50022.cpp
      libomptarget :: nvptx64-nvidia-cuda-LTO :: mapping/map_back_race.cpp
      libomptarget :: nvptx64-nvidia-cuda-LTO :: offloading/bug47654.cpp
      libomptarget :: nvptx64-nvidia-cuda-LTO :: offloading/bug49334.cpp
      libomptarget :: nvptx64-nvidia-cuda-LTO :: offloading/bug50022.cpp
      "
    VV_COMP_LIT_XFAIL:
      ""
    VV_RUN_LIT_XFAIL:
      ""

.oswald-assert:
  extends: [.oswald]
  variables:
    BUILD_ID: oswald-assert
    CMAKE_BUILD_OPTS: -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_ASSERTIONS=True

.explorer:
  tags: [shell, explorer]
  variables:
    BUILD_ID: explorer
    MODULES: git
    PATH_PREPEND: ""
    ROCM_PATH: # used by Kokkos build
      /opt/rocm
    CMAKE: cmake
    GCC_DIR: /usr
    NINJA: ninja
    PYTHON: /usr/bin/python3
    CMAKE_BUILD_OPTS: -DCMAKE_BUILD_TYPE=Release
    # If lld isn't built, OpenMP offloading tests for AMDGPU fail:
    #
    #   clang-14: error: unable to execute command: Executable "lld" doesn't exist!
#   #   clang-14: error: amdgcn-link command failed with exit code 1 (use -v to see invocation)
    LLVM_ENABLE_PROJECTS: "clang;lld"
    LLVM_ENABLE_RUNTIMES: "openmp"
    CPU_TRIPLE: "x86_64-pc-linux-gnu"
    CPU_COUNT:  4
    GPU_TRIPLE: "amdgcn-amd-amdhsa"
    GPU_COUNT:  2
    KOKKOS_CMAKE_OPTS: -DKokkos_ARCH_VEGA906=On
    LIT_NPROC_DIVISOR: 1
    TEST_LIT_XFAIL:
      ""
    TEST_LIT_XFAIL_NOT:
      ""
    TEST_LIT_FILTER_OUT_LIST:
      "
      Clang :: Driver/rocm-detect.hip
      libomp :: parallel/omp_parallel_num_threads.c
      libomp :: worksharing/single/omp_single.c
      "
    VV_COMP_LIT_XFAIL:
      ""
    VV_RUN_LIT_XFAIL:
      ""

.explorer-assert:
  extends: [.explorer]
  variables:
    BUILD_ID: explorer-assert
    CMAKE_BUILD_OPTS: -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_ASSERTIONS=True
    TEST_LIT_XFAIL:
      "
      Clang :: OpenACC/directives/amdgcn-amd-amdhsa/parallel-da.c
      "

.milan:
  tags: [shell, milan]
  variables:
    BUILD_ID: milan
    MODULES: gnu/12.2.0
    PATH_PREPEND: ""
    CMAKE: cmake
    NINJA: ninja
    PYTHON: /usr/bin/python3
    CMAKE_BUILD_OPTS: -DCMAKE_BUILD_TYPE=Release
    LLVM_ENABLE_PROJECTS: "clang"
    LLVM_ENABLE_RUNTIMES: "openmp"
    CPU_TRIPLE: "x86_64-pc-linux-gnu"
    CPU_COUNT: 4
    TEST_LIT_XFAIL:
      ""
    TEST_LIT_XFAIL_NOT:
      ""
    TEST_LIT_FILTER_OUT_LIST:
      ""
    VV_COMP_LIT_XFAIL:
      ""
    VV_RUN_LIT_XFAIL:
      "
      External/openacc_vv/acc_map_data.c.test
      External/openacc_vv/acc_unmap_data.c.test
      "

.milan-assert:
  extends: [.milan]
  variables:
    BUILD_ID: milan-assert
    CMAKE_BUILD_OPTS: -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_ASSERTIONS=True

.debug:
  extends: [.milan]
  variables:
    BUILD_ID: debug
    CMAKE_BUILD_OPTS: -DCMAKE_BUILD_TYPE=Debug

# Not setup or cleanup.
.non-utility:
  dependencies: []
  variables:
    GIT_STRATEGY: none
  before_script:
    - echo -e "\e[0Ksection_start:`date +%s`:prepare_for_job[collapsed=true]\r\e[0KPrepare for job"
    - echo $MODULES
    - if test x"$MODULES" != x; then module load $MODULES; fi
    - echo $PATH_PREPEND
    - if test x"$PATH_PREPEND" != x; then PATH="$PATH_PREPEND:$PATH"; fi
    - echo $PATH
    - pwd
    - echo $BUILD_DIR
    - cd $BUILD_DIR/build
    - echo -e "\e[0Ksection_end:`date +%s`:prepare_for_job\r\e[0K"
  after_script:
    - echo -e "\e[0Ksection_start:`date +%s`:show_stats[collapsed=true]\r\e[0KShow ccache and build statistics"
    - echo "$LLVM_CCACHE_PARAMS"
    - env $LLVM_CCACHE_PARAMS ccache -sp
    - du -hs $BUILD_DIR/build
    - if test -e $BUILD_DIR/install; then du -hs $BUILD_DIR/install; fi
    - echo -e "\e[0Ksection_end:`date +%s`:show_stats\r\e[0K"

#-------------------------------------------------------------------------------
# setup
#-------------------------------------------------------------------------------

.setup:
  stage: setup
  script:
    - pwd
    - echo $BUILD_DIR_PROJ
    # Try to remove anything older than 6 hours that was left by a previous
    # pipeline for this project.  Doing this in the setup stage instead of
    # cleanup stage ensures that it runs before a new job even if prior jobs
    # failed or were canceled.  git clone creates files with old modification
    # times, so check file creation time (-cmin) instead.
    - find $BUILD_DIR_PROJ -cmin +360 -delete || true
    - mkdir -p $BUILD_DIR_PROJ
    - echo $BUILD_DIR
    # Remove this build config's build directory if it already exists.  It
    # might exist if, for example, this setup job previously failed due to a
    # transient Gitlab/ExCL problem.
    - rm -rf $BUILD_DIR
    - mkdir $BUILD_DIR
    - mkdir $BUILD_DIR/build
    # Clone the runner's git clone into the NFS-mounted build directory.  We
    # cannot use the runner's git clone directly because its location relative
    # to the build directory varies across runners, and that would cause ccache
    # to miss whenever the runner changes no matter how we set CCACHE_BASEDIR.
    # We've also tried creating a symlink to the runner's git clone at the
    # start of every job, but that causes ccache to miss in the same manner, so
    # apparently the symlink is expanded somewhere.
    - git --version
    - time git clone `pwd` $BUILD_DIR/source

leconte (setup):
  extends: [.leconte, .setup]

leconte-assert (setup):
  extends: [.leconte-assert, .setup]

oswald (setup):
  extends: [.oswald, .setup]

oswald-assert (setup):
  extends: [.oswald-assert, .setup]

explorer (setup):
  extends: [.explorer, .setup]

explorer-assert (setup):
  extends: [.explorer-assert, .setup]

milan (setup):
  extends: [.milan, .setup]

milan-assert (setup):
  extends: [.milan-assert, .setup]

debug (setup):
  extends: [.debug, .setup]

#-------------------------------------------------------------------------------
# cleanup
#-------------------------------------------------------------------------------

.rm-build-dir:
  variables:
    GIT_STRATEGY: none
  script:
    - pwd
    - echo $BUILD_DIR
    - rm -rf $BUILD_DIR
    - rmdir $BUILD_DIR_PROJ || true

.cleanup:
  stage: cleanup
  extends: .rm-build-dir

.manual-cleanup:
  stage: manual cleanup
  extends: .rm-build-dir
  when: manual
  needs: []

leconte (cleanup):
  extends: [.leconte, .cleanup]
  needs:
    - job: leconte (test)
      artifacts: false
    - job: leconte (vv)
      artifacts: false
      optional: true
    - job: leconte (kokkos)
      artifacts: false
      optional: true

leconte-assert (cleanup):
  extends: [.leconte-assert, .cleanup]
  needs:
    - job: leconte-assert (test)
      artifacts: false
    - job: leconte-assert (vv)
      artifacts: false
      optional: true
    - job: leconte-assert (kokkos)
      artifacts: false
      optional: true

oswald (cleanup):
  extends: [.oswald, .cleanup]
  needs:
    - job: oswald (test)
      artifacts: false
    - job: oswald (vv)
      artifacts: false
      optional: true
    - job: oswald (kokkos)
      artifacts: false
      optional: true

oswald-assert (cleanup):
  extends: [.oswald-assert, .cleanup]
  needs:
    - job: oswald-assert (test)
      artifacts: false
    - job: oswald-assert (vv)
      artifacts: false
      optional: true
    - job: oswald-assert (kokkos)
      artifacts: false
      optional: true

explorer (cleanup):
  extends: [.explorer, .cleanup]
  needs:
    - job: explorer (test)
      artifacts: false
    - job: explorer (vv)
      artifacts: false
      optional: true
    - job: explorer (kokkos)
      artifacts: false
      optional: true

explorer-assert (cleanup):
  extends: [.explorer-assert, .cleanup]
  needs:
    - job: explorer-assert (test)
      artifacts: false
    - job: explorer-assert (vv)
      artifacts: false
      optional: true
    - job: explorer-assert (kokkos)
      artifacts: false
      optional: true

milan (cleanup):
  extends: [.milan, .cleanup]
  needs:
    - job: milan (test)
      artifacts: false
    - job: milan (vv)
      artifacts: false
      optional: true
    - job: milan (kokkos)
      artifacts: false
      optional: true

milan-assert (cleanup):
  extends: [.milan-assert, .cleanup]
  needs:
    - job: milan-assert (test)
      artifacts: false
    - job: milan-assert (vv)
      artifacts: false
      optional: true
    - job: milan-assert (kokkos)
      artifacts: false
      optional: true

debug (cleanup):
  extends: [.debug, .cleanup]
  needs:
    - job: debug (test)
      artifacts: false
    - job: debug (vv)
      artifacts: false
      optional: true
    - job: debug (kokkos)
      artifacts: false
      optional: true

leconte (manual cleanup):
  extends: [.leconte, .manual-cleanup]

leconte-assert (manual cleanup):
  extends: [.leconte-assert, .manual-cleanup]

oswald (manual cleanup):
  extends: [.oswald, .manual-cleanup]

oswald-assert (manual cleanup):
  extends: [.oswald-assert, .manual-cleanup]

explorer (manual cleanup):
  extends: [.explorer, .manual-cleanup]

explorer-assert (manual cleanup):
  extends: [.explorer-assert, .manual-cleanup]

milan (manual cleanup):
  extends: [.milan, .manual-cleanup]

milan-assert (manual cleanup):
  extends: [.milan-assert, .manual-cleanup]

debug (manual cleanup):
  extends: [.debug, .manual-cleanup]

z-cleanup-pipeline-builds:
  stage: manual cleanup
  when: manual
  needs: []
  tags: [shell, milan]
  variables:
    GIT_STRATEGY: none
  script:
    - echo $BUILD_DIRS
    - rm -rf $BUILD_DIRS

z-cleanup-project-builds:
  stage: manual cleanup
  when: manual
  needs: []
  tags: [shell, milan]
  variables:
    GIT_STRATEGY: none
  script:
    - echo $BUILD_DIR_PROJ
    - rm -rf $BUILD_DIR_PROJ

#-------------------------------------------------------------------------------
# config
#-------------------------------------------------------------------------------

.config:
  extends: .non-utility
  stage: config
  script:
    - echo -e "\e[0Ksection_start:`date +%s`:cmake[collapsed=true]\r\e[0KRun cmake"
    - echo $CMAKE
    - $CMAKE --version
    - echo $CMAKE_BUILD_OPTS
    - echo $GCC_DIR
    - echo $LLVM_CCACHE_PARAMS
    - echo $PYTHON
    - $PYTHON --version
    - echo $LLVM_TARGETS_TO_BUILD
    - echo $LLVM_ENABLE_PROJECTS
    - echo $LLVM_ENABLE_RUNTIMES
    - time $CMAKE -G Ninja
                  $CMAKE_BUILD_OPTS
                  -DCMAKE_INSTALL_PREFIX=../install
                  -DLLVM_CCACHE_BUILD=ON
                  -DLLVM_USE_SPLIT_DWARF=true
                  -DCMAKE_C_COMPILER=gcc
                  -DCMAKE_CXX_COMPILER=g++
                  -DGCC_INSTALL_PREFIX=$GCC_DIR
                  -DLLVM_CCACHE_PARAMS="$LLVM_CCACHE_PARAMS"
                  -DLLVM_TARGETS_TO_BUILD="$LLVM_TARGETS_TO_BUILD"
                  -DLLVM_ENABLE_PROJECTS="$LLVM_ENABLE_PROJECTS"
                  -DLLVM_ENABLE_RUNTIMES="$LLVM_ENABLE_RUNTIMES"
                  -DPython3_EXECUTABLE=$PYTHON
                  -DLLVM_LIT_ARGS='-s -vv'
                  ../source/llvm
      |& tee $CI_PROJECT_DIR/cmake-log.txt
    - cp CMakeCache.txt $CI_PROJECT_DIR
    - echo -e "\e[0Ksection_end:`date +%s`:cmake\r\e[0K"
  artifacts:
    when: always
    paths: [cmake-log.txt, CMakeCache.txt]

leconte (config):
  extends: [.leconte, .config]
  needs:
    - job: leconte (setup)
      artifacts: false

leconte-assert (config):
  extends: [.leconte-assert, .config]
  needs:
    - job: leconte-assert (setup)
      artifacts: false

oswald (config):
  extends: [.oswald, .config]
  needs:
    - job: oswald (setup)
      artifacts: false

oswald-assert (config):
  extends: [.oswald-assert, .config]
  needs:
    - job: oswald-assert (setup)
      artifacts: false

explorer (config):
  extends: [.explorer, .config]
  needs:
    - job: explorer (setup)
      artifacts: false

explorer-assert (config):
  extends: [.explorer-assert, .config]
  needs:
    - job: explorer-assert (setup)
      artifacts: false

milan (config):
  extends: [.milan, .config]
  needs:
    - job: milan (setup)
      artifacts: false

milan-assert (config):
  extends: [.milan-assert, .config]
  needs:
    - job: milan-assert (setup)
      artifacts: false

debug (config):
  extends: [.debug, .config]
  needs:
    - job: debug (setup)
      artifacts: false

#-------------------------------------------------------------------------------
# build
#-------------------------------------------------------------------------------

.build:
  extends: .non-utility
  stage: build
  script:
    - echo -e "\e[0Ksection_start:`date +%s`:build[collapsed=true]\r\e[0KBuild"
    - echo $NINJA
    - $NINJA --version
    - time $NINJA -l `nproc` |& tee $CI_PROJECT_DIR/build-log.txt
    - time $NINJA -l `nproc` install
    - echo -e "\e[0Ksection_end:`date +%s`:build\r\e[0K"
  artifacts:
    when: always
    paths: [build-log.txt]

leconte (build):
  extends: [.leconte, .build]
  needs:
    - job: leconte (config)
      artifacts: false

leconte-assert (build):
  extends: [.leconte-assert, .build]
  needs:
    - job: leconte-assert (config)
      artifacts: false

oswald (build):
  extends: [.oswald, .build]
  needs:
    - job: oswald (config)
      artifacts: false

oswald-assert (build):
  extends: [.oswald-assert, .build]
  needs:
    - job: oswald-assert (config)
      artifacts: false

explorer (build):
  extends: [.explorer, .build]
  needs:
    - job: explorer (config)
      artifacts: false

explorer-assert (build):
  extends: [.explorer-assert, .build]
  needs:
    - job: explorer-assert (config)
      artifacts: false

milan (build):
  extends: [.milan, .build]
  needs:
    - job: milan (config)
      artifacts: false

milan-assert (build):
  extends: [.milan-assert, .build]
  needs:
    - job: milan-assert (config)
      artifacts: false

debug (build):
  extends: [.debug, .build]
  needs:
    - job: debug (config)
      artifacts: false

#-------------------------------------------------------------------------------
# test
#-------------------------------------------------------------------------------

.test:
  extends: .non-utility
  stage: test
  script:
    - echo $CHECK_TARGETS
    - echo $NINJA
    - $NINJA --version
    #...........................................................................
    # Build test suite before running it so we can time those steps separately.
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:build_regression_tests[collapsed=true]\r\e[0KBuild regression test suite"
    - time LIT_FILTER_OUT=. LIT_OPTS=--allow-empty-runs
      $NINJA -l `nproc` $CHECK_TARGETS
      |& tee $CI_PROJECT_DIR/check-all-build-log.txt
    - echo -e "\e[0Ksection_end:`date +%s`:build_regression_tests\r\e[0K"
    #...........................................................................
    # Check that no misconfiguration is quietly disabling key features and thus
    # tests.  For example, not adding the gitlab-runner account to the required
    # render/video groups quietly disables OpenMP offloading to AMD GPU.
    #
    # Check that device counts are computed correctly by the test suite based on
    # known device counts for each host.
    #
    # A grep failure within an "if" terminates the "if" as expected, but somehow
    # it doesn't cause the job to fail or prevent commands in subsequent list
    # items from executing unless we have the "|| false" after the "fi".  This
    # doesn't make sense to me, but it's how gitlab CI apparently works right
    # now.
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:check_regression_tests[collapsed=true]\r\e[0KCheck regression test suite config"
    - tl=$CI_PROJECT_DIR/check-all-show-tests.txt
    - LIT_OPTS=--show-tests $NINJA $CHECK_TARGETS > $tl 2>&1
    - echo "$CPU_TRIPLE" "$CPU_COUNT" &&
      echo "$GPU_TRIPLE" "$GPU_COUNT"
    - echo "Test counts for libomptarget "'::'" $CPU_TRIPLE (expecting > 0):" &&
      grep -c "^ *libomptarget "'::'" $CPU_TRIPLE ::" $tl
    - if test x"$GPU_TRIPLE" != x; then
         echo "Test counts for libomptarget "'::'" $GPU_TRIPLE (expecting > 0):"
         && grep -c "^ *libomptarget "'::'" $GPU_TRIPLE ::" $tl;
      fi || false
    - clacc_branch=`
        echo "$CI_COMMIT_BRANCH" |
        grep '^\(clacc\|jdenny-openacc\)' |
        grep -v '^clacc/llvm.org-ci/' ||
        true`
    - echo "$clacc_branch"
    - if test x"$clacc_branch" != x; then
        echo "Test counts for libacc2omp "'::'" $CPU_TRIPLE (expecting > 0):" &&
        grep -c "^ *libacc2omp "'::'" $CPU_TRIPLE ::" $tl &&
        prefix="Device counts for" &&
        echo "Device counts for $CPU_TRIPLE (expecting $CPU_COUNT):" &&
        for suite in "libacc2omp "'::'" $CPU_TRIPLE"
                     "libacc2omp "'::'" multitarget"
                     "Clang"; do
          grep "$prefix '$suite'.*'$CPU_TRIPLE'"':'" $CPU_COUNT[,}]" $tl;
        done &&
        if test x"$GPU_TRIPLE" != x; then
          echo "Test counts for libacc2omp "'::'" $GPU_TRIPLE (expecting > 0):"
          && grep -c "^ *libacc2omp "'::'" $GPU_TRIPLE ::" $tl &&
          echo "Device counts for $GPU_TRIPLE (expecting $GPU_COUNT):" &&
          for suite in "libacc2omp "'::'" $GPU_TRIPLE"
                       "libacc2omp "'::'" multitarget"
                       "Clang"; do
            grep "$prefix '$suite'.*'$GPU_TRIPLE'"':'" $GPU_COUNT[,}]" $tl;
          done
        fi
      fi || false
    - echo -e "\e[0Ksection_end:`date +%s`:check_regression_tests\r\e[0K"
    #...........................................................................
    # Run the test suite.
    #
    # LIT_NPROC_DIVISOR is set to limit the number of tests launched at once so
    # we don't overwhelm the accelerators (leconte GPUs, in particular),
    # producing OpenMP offload test failures.
    #
    # Hung tests should be killed when the CI job times out, but there's no
    # reason to wait hours for that, so we use lit's --timeout option.
    # Moreover, that permits lit to retry a hung test that has the
    # ALLOW_RETRIES directive.  40 mins should be long enough for any test and
    # is hopefully short enough that retries have a chance to succeed before the
    # CI job times out.
    #
    # In case check-all runs multiple lit invocations (e.g., a separate
    # invocation for openmp because it's in LLVM_ENABLE_RUNTIMES), use lit's
    # --ignore-fail so that all lit invocations actually run.  The count printed
    # by grep tells us how many test suite summaries we need to search for.
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:run_regression_tests[collapsed=true]\r\e[0KRun regression test suite"
    - if test x"$clacc_branch" != x; then
        TEST_LIT_XFAIL="$TEST_LIT_XFAIL $TEST_CLACC_LIT_XFAIL";
      fi
    - export LIT_XFAIL=`
        echo "$TEST_LIT_XFAIL"
        | sed -e 's/\([^:]\)  *\([^:]\)/\1;\2/g' -e 's/^ *//' -e 's/ *$//'
      `
    - export LIT_XFAIL_NOT=`
        echo "$TEST_LIT_XFAIL_NOT"
        | sed -e 's/\([^:]\)  *\([^:]\)/\1;\2/g' -e 's/^ *//' -e 's/ *$//'
      `
    - export LIT_FILTER_OUT=`
        echo "$TEST_LIT_FILTER_OUT_LIST"
        | sed -e 's/\([^:]\)  *\([^:]\)/\1|\2/g' -e 's/^ */^(/' -e 's/ *$/)$/'
              -e 's/\./\\./g'
      `
    - echo "$LIT_XFAIL"
    - echo "$LIT_XFAIL_NOT"
    - echo "$LIT_FILTER_OUT"
    - NPROC=`nproc`
    - echo "$NPROC"
    - echo "$LIT_NPROC_DIVISOR"
    - time FILECHECK_OPTS='-dump-input-filter=all -vv -color'
      LIT_OPTS="
        --timeout 2400 -j `expr $NPROC / $LIT_NPROC_DIVISOR`
        --ignore-fail --xunit-xml-output $CI_PROJECT_DIR/check-all.xml
        --show-xfail --show-excluded --show-skipped
      "
      $NINJA -l `nproc` $CHECK_TARGETS
      |& tee $CI_PROJECT_DIR/check-all-log.txt
    - echo -e "\e[0Ksection_end:`date +%s`:run_regression_tests\r\e[0K"
    #...........................................................................
    # Check for regression test failure.
    #...........................................................................
    - "! grep -c \"'--ignore-fail' was specified\"
                 $CI_PROJECT_DIR/check-all-log.txt"
  artifacts:
    when: always
    paths: [check-all-build-log.txt, check-all-show-tests.txt,
            check-all-log.txt, check-all.xml]
    reports:
      junit: check-all.xml

leconte (test):
  extends: [.leconte, .test]
  needs:
    - job: leconte (build)
      artifacts: false

leconte-assert (test):
  extends: [.leconte-assert, .test]
  needs:
    - job: leconte-assert (build)
      artifacts: false

oswald (test):
  extends: [.oswald, .test]
  needs:
    - job: oswald (build)
      artifacts: false

oswald-assert (test):
  extends: [.oswald-assert, .test]
  needs:
    - job: oswald-assert (build)
      artifacts: false

explorer (test):
  extends: [.explorer, .test]
  needs:
    - job: explorer (build)
      artifacts: false

explorer-assert (test):
  extends: [.explorer-assert, .test]
  needs:
    - job: explorer-assert (build)
      artifacts: false

milan (test):
  extends: [.milan, .test]
  needs:
    - job: milan (build)
      artifacts: false

milan-assert (test):
  extends: [.milan-assert, .test]
  needs:
    - job: milan-assert (build)
      artifacts: false

debug (test):
  extends: [.debug, .test]
  needs:
    - job: debug (build)
      artifacts: false

#-------------------------------------------------------------------------------
# Clacc-only jobs.
#-------------------------------------------------------------------------------

.clacc:
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^(clacc|jdenny-openacc)/ &&
          $CI_COMMIT_BRANCH !~ /^clacc\/llvm.org-ci\//

#-------------------------------------------------------------------------------
# vv
#
# Clone llvm-test-suite.git and the OpenACC V&V suite, and run the latter via
# the former.
#-------------------------------------------------------------------------------

.vv:
  extends: [.non-utility, .clacc]
  stage: vv
  script:
    - export LD_LIBRARY_PATH=$BUILD_DIR/install/lib:$LD_LIBRARY_PATH
    - echo $LD_LIBRARY_PATH
    - export VV_COMP_LIT_XFAIL=`
        echo "$VV_COMP_LIT_XFAIL"
        | sed -e 's/\([^:]\)  *\([^:]\)/\1;\2/g' -e 's/^ *//' -e 's/ *$//'
      `
    - export VV_RUN_LIT_XFAIL=`
        echo "$VV_RUN_LIT_XFAIL"
        | sed -e 's/\([^:]\)  *\([^:]\)/\1;\2/g' -e 's/^ *//' -e 's/ *$//'
      `
    #...........................................................................
    # Clone llvm-test-suite.git and the OpenACC V&V suite.
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:clone_vv_tests[collapsed=true]\r\e[0KClone llvm-test-suite.git and OpenACC V&V suite"
    - cd ..
    - rm -rf openacc-vv
    - mkdir openacc-vv
    - cd openacc-vv
    - git init llvm-test-suite
    - cd llvm-test-suite
    - git remote add origin https://github.com/llvm-doe-org/llvm-test-suite.git
    # We exclude some very large directories from llvm-test-suite.git so it
    # doesn't take so long to clone.
    - git config core.sparseCheckout true
    - echo '/*'              >> .git/info/sparse-checkout
    - echo '!/ABI-Testsuite' >> .git/info/sparse-checkout
    - echo '!/Bitcode'       >> .git/info/sparse-checkout
    - echo '!/MultiSource'   >> .git/info/sparse-checkout
    - echo $VV_LLVM_TEST_SUITE_COMMIT
    - git fetch --depth=1 --filter=blob:none origin $VV_LLVM_TEST_SUITE_COMMIT
    - time git checkout $VV_LLVM_TEST_SUITE_COMMIT
    - cd ..
    - time git clone https://github.com/OpenACCUserGroup/OpenACCV-V.git
    - cd OpenACCV-V
    - echo $VV_COMMIT
    - git checkout $VV_COMMIT
    - echo -e "\e[0Ksection_end:`date +%s`:clone_vv_tests\r\e[0K"
    #...........................................................................
    # Build the OpenACC V&V suite.
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:build_vv_tests[collapsed=true]\r\e[0KBuild OpenACC V&V suite"
    # On explorer when using -fopenmp-targets=amdgcn-amd-amdhsa, Clang complains
    # about the definition of false/true in acc_testsuite.h, and all tests fail
    # as a result.  That's not an OpenACC-specific support issue, so we work
    # around it to get meaningful OpenACC results.
    - sed -i -e 's/typedef enum { false, true } bool;/#include <stdbool.h>/'
          Tests/acc_testsuite.h
    # Fix an incorrect test.
    - sed -i -e 's/copy(totals\[0:10\])/copy(totals[0:11])/'
          Tests/atomic_capture_expr_plus_x.c
    - cd ../llvm-test-suite
    - mkdir build
    - cd build
    # -fopenacc-fake-* options enable building OpenACC applications that behave
    # correctly without a full implementation of the associated OpenACC
    # features.  The V&V suite is a convenient way to check for unexpected
    # issues with the incomplete implementations.
    - export VV_CFLAGS="-fopenacc -fopenacc-fake-async-wait -lm $VV_CFLAGS"
    - if test x"$GPU_TRIPLE" != x; then
        export VV_CFLAGS="$VV_CFLAGS -fopenmp-targets=$GPU_TRIPLE";
      fi
    - echo "$VV_CFLAGS"
    - time $CMAKE -G Ninja
                  -DCMAKE_BUILD_TYPE=Release
                  -DTEST_SUITE_OPENACCVV_ROOT=`pwd`/../../OpenACCV-V
                  -DCMAKE_C_COMPILER=`pwd`/../../../install/bin/clang
                  -DCMAKE_CXX_COMPILER=`pwd`/../../../install/bin/clang++
                  -DTEST_SUITE_SUBDIRS=External/openacc_vv
                  -DOpenACC_C_FLAGS="$VV_CFLAGS"
                  -DOpenACC_CXX_FLAGS="$VV_CFLAGS"
                  ..
      |& tee $CI_PROJECT_DIR/openacc-vv-build-log.txt
    # Some tests might fail to compile, but we don't want that to prevent
    # compiling and running the rest of the tests, so we use -k with a large
    # value we'll never reach.
    - time $NINJA -l `nproc` -k 99999
      |& tee -a $CI_PROJECT_DIR/openacc-vv-build-log.txt
      || true
    - echo -e "\e[0Ksection_end:`date +%s`:build_vv_tests\r\e[0K"
    #...........................................................................
    # Run OpenaCC V&V suite tests for which we expect compilation failures.
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:run_vv_tests_comp_xfails[collapsed=true]\r\e[0KRun OpenACC V&V suite expected compilation failures"
    - echo "$VV_COMP_LIT_XFAIL"
    - if test x"$VV_COMP_LIT_XFAIL" = x; then
        echo 'No compilation fails expected'
          |& tee $CI_PROJECT_DIR/openacc-vv-log.txt;
      else
        echo 'Results for expected compilation fails:'
          |& tee $CI_PROJECT_DIR/openacc-vv-log.txt &&
        time for test in `echo "$VV_COMP_LIT_XFAIL" |
                          sed -e 's/;/ /g' -e 's/\./\\./g'`; do
          ../../../build/bin/llvm-lit -s -vv --timeout 2400 --ignore-fail
                                      --filter="$test" .  >test-result 2>&1 &&
          if grep -q 'Executable Missing'":"' *1$' test-result; then
            echo "  expected compilation fail"':'" $test";
          else
            echo "  unexpected compilation pass"':'" $test";
            cat test-result;
          fi
        done |& tee -a $CI_PROJECT_DIR/openacc-vv-log.txt;
      fi
    - echo -e "\e[0Ksection_end:`date +%s`:run_vv_tests_comp_xfails\r\e[0K"
    #...........................................................................
    # Run remaining OpenaCC V&V suite tests.
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:run_vv_tests[collapsed=true]\r\e[0KRun remaining OpenACC V&V suite tests"
    - NPROC=`nproc`
    - echo "$NPROC"
    - echo "$LIT_NPROC_DIVISOR"
    - if test x"$VV_COMP_LIT_XFAIL" != x; then
        export LIT_FILTER_OUT=`echo "$VV_COMP_LIT_XFAIL" |
                               sed -e 's/;/|/g' -e 's/\./\\./g'`;
      fi
    - echo "$LIT_FILTER_OUT"
    - echo "$VV_RUN_LIT_XFAIL"
    - time ../../../build/bin/llvm-lit
        -s -vv --timeout 2400 -j `expr $NPROC / $LIT_NPROC_DIVISOR`
        --ignore-fail --xunit-xml-output $CI_PROJECT_DIR/openacc-vv.xml
        --show-xfail --xfail="$VV_RUN_LIT_XFAIL" .
      |& tee -a $CI_PROJECT_DIR/openacc-vv-log.txt
    - echo -e "\e[0Ksection_end:`date +%s`:run_vv_tests\r\e[0K"
    #...........................................................................
    # Check for unexpected compilation or run results.
    #...........................................................................
    - "! grep -c
              \"'--ignore-fail' was specified\\|unexpected compilation pass\"
              $CI_PROJECT_DIR/openacc-vv-log.txt"
  artifacts:
    when: always
    paths: [openacc-vv-build-log.txt, openacc-vv-log.txt, openacc-vv.xml]
    reports:
      junit: openacc-vv.xml

leconte (vv):
  extends: [.leconte, .vv]
  needs:
    - job: leconte (build)
      artifacts: false

leconte-assert (vv):
  extends: [.leconte-assert, .vv]
  needs:
    - job: leconte-assert (build)
      artifacts: false

oswald (vv):
  extends: [.oswald, .vv]
  needs:
    - job: oswald (build)
      artifacts: false

oswald-assert (vv):
  extends: [.oswald-assert, .vv]
  needs:
    - job: oswald-assert (build)
      artifacts: false

explorer (vv):
  extends: [.explorer, .vv]
  needs:
    - job: explorer (build)
      artifacts: false

explorer-assert (vv):
  extends: [.explorer-assert, .vv]
  needs:
    - job: explorer-assert (build)
      artifacts: false

milan (vv):
  extends: [.milan, .vv]
  needs:
    - job: milan (build)
      artifacts: false

milan-assert (vv):
  extends: [.milan-assert, .vv]
  needs:
    - job: milan-assert (build)
      artifacts: false

debug (vv):
  extends: [.debug, .vv]
  needs:
    - job: debug (build)
      artifacts: false

#-------------------------------------------------------------------------------
# kokkos
#
# Clone Kokkos and kokkos-ornl-int-test.git, and try to build some tests in the
# latter using required parts of the former.
#-------------------------------------------------------------------------------

.kokkos:
  extends: [.non-utility, .clacc]
  stage: kokkos
  script:
    - export LD_LIBRARY_PATH=$BUILD_DIR/install/lib:$LD_LIBRARY_PATH
    - echo $LD_LIBRARY_PATH
    #...........................................................................
    # Clone Kokkos.
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:clone_kokkos[collapsed=true]\r\e[0KClone kokkos.git"
    - cd $BUILD_DIR
    - rm -rf kokkos
    - mkdir kokkos
    - cd kokkos
    - time git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@code.ornl.gov/jum/kokkos
    - cd kokkos
    - echo $KOKKOS_COMMIT
    - time git checkout $KOKKOS_COMMIT
    - echo -e "\e[0Ksection_end:`date +%s`:clone_kokkos\r\e[0K"
    #...........................................................................
    # Build kokkos.
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:build_kokkos[collapsed=true]\r\e[0KBuild Kokkos"
    - mkdir build && cd build
    - echo $CMAKE
    - $CMAKE --version
    - echo $KOKKOS_CMAKE_OPTS
    - time $CMAKE -G Ninja
        -DCMAKE_CXX_COMPILER=$BUILD_DIR/install/bin/clang++
        -DCMAKE_CXX_STANDARD=17
        -DCMAKE_CXX_FLAGS="$KOKKOS_CFLAGS"
        -DCMAKE_INSTALL_PREFIX=`pwd`/../install
        -DCMAKE_BINARY_DIR=`pwd`
        -DKokkos_ENABLE_OPENACC=On
        -DKokkos_ENABLE_HWLOC=Off
        -DKokkos_ENABLE_TESTS=On
        $KOKKOS_CMAKE_OPTS
        ..
    - echo $NINJA
    - $NINJA --version
    - time $NINJA -l `nproc` install |& tee $CI_PROJECT_DIR/kokkos-build-log.txt
    - echo -e "\e[0Ksection_end:`date +%s`:build_kokkos\r\e[0K"
    #...........................................................................
    # Run kokkos test suite.
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:run_kokkos_tests[collapsed=true]\r\e[0KRun Kokkos test suite"
    - time $NINJA -l `nproc` test || KOKKOS_TEST_FAIL=1
    - cp $BUILD_DIR/kokkos/kokkos/build/Testing/Temporary/LastTest.log
         $CI_PROJECT_DIR/kokkos-test-log.txt
    - if test x$KOKKOS_TEST_FAIL = x1; then exit 1; fi
    - echo -e "\e[0Ksection_end:`date +%s`:run_kokkos_tests\r\e[0K"
    #...........................................................................
    # Clone kokkos-ornl-int-test.git.
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:clone_kokkos_tests[collapsed=true]\r\e[0KClone kokkos-ornl-int-test.git"
    - cd $BUILD_DIR/kokkos
    - time git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@code.ornl.gov/f6l/kokkos-ornl-int-test
    - cd kokkos-ornl-int-test
    - echo $KOKKOS_TESTS_COMMIT
    - time git checkout $KOKKOS_TESTS_COMMIT
    - echo -e "\e[0Ksection_end:`date +%s`:clone_kokkos_tests\r\e[0K"
    #...........................................................................
    # Build and run kokkos-ornl-int-test.git/examples/openacc-parallel-reduce-md
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:openacc-parallel-reduce-md[collapsed=true]\r\e[0KCheck kokkos-ornl-int-test.git/examples/openacc-parallel-reduce-md"
    - cd $BUILD_DIR/kokkos/kokkos-ornl-int-test/examples/openacc-parallel-reduce-md
    - mkdir build && cd build
    - echo $CMAKE
    - $CMAKE --version
    - time $CMAKE -G Ninja
        -DKokkos_ROOT=$BUILD_DIR/kokkos/kokkos/install
        -DCMAKE_CXX_COMPILER=$BUILD_DIR/install/bin/clang++
        -DCMAKE_CXX_FLAGS="-DVERIFY -O3 -lm $KOKKOS_CFLAGS"
        ..
    - echo $NINJA
    - $NINJA --version
    - time $NINJA -l `nproc`
    - time ./openacctest
    - echo -e "\e[0Ksection_end:`date +%s`:openacc-parallel-reduce-md\r\e[0K"
    #...........................................................................
    # Build and run
    # kokkos-ornl-int-test.git/examples/openacc-parallel-reduce-single
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:openacc-parallel-reduce-single[collapsed=true]\r\e[0KCheck kokkos-ornl-int-test.git/examples/openacc-parallel-reduce-single"
    - cd $BUILD_DIR/kokkos/kokkos-ornl-int-test/examples/openacc-parallel-reduce-single
    - mkdir build && cd build
    - echo $CMAKE
    - $CMAKE --version
    - time $CMAKE -G Ninja
        -DKokkos_ROOT=$BUILD_DIR/kokkos/kokkos/install
        -DCMAKE_CXX_COMPILER=$BUILD_DIR/install/bin/clang++
        -DCMAKE_CXX_FLAGS="-DVERIFY -O3 -lm $KOKKOS_CFLAGS"
        ..
    - echo $NINJA
    - $NINJA --version
    - time $NINJA -l `nproc`
    - time ./openacctest
    - echo -e "\e[0Ksection_end:`date +%s`:openacc-parallel-reduce-single\r\e[0K"
    #...........................................................................
    # Build and run
    # kokkos-ornl-int-test.git/examples/openacc-parallel-reduce-team
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:openacc-parallel-reduce-team[collapsed=true]\r\e[0KCheck kokkos-ornl-int-test.git/examples/openacc-parallel-reduce-team"
    - cd $BUILD_DIR/kokkos/kokkos-ornl-int-test/examples/openacc-parallel-reduce-team
    - mkdir build && cd build
    - echo $CMAKE
    - $CMAKE --version
    - time $CMAKE -G Ninja
        -DKokkos_ROOT=$BUILD_DIR/kokkos/kokkos/install
        -DCMAKE_CXX_COMPILER=$BUILD_DIR/install/bin/clang++
        -DCMAKE_CXX_FLAGS="-DVERIFY -O3 -lm $KOKKOS_CFLAGS"
        ..
    - echo $NINJA
    - $NINJA --version
    - time $NINJA -l `nproc`
    - time ./openacctest
    - echo -e "\e[0Ksection_end:`date +%s`:openacc-parallel-reduce-team\r\e[0K"
    #...........................................................................
    # Build and run kokkos-ornl-int-test.git/examples/openacc-performance
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:openacc-performance[collapsed=true]\r\e[0KCheck kokkos-ornl-int-test.git/examples/openacc-performance"
    - cd $BUILD_DIR/kokkos/kokkos-ornl-int-test/examples/openacc-performance
    - mkdir build && cd build
    - echo $CMAKE
    - $CMAKE --version
    - time $CMAKE -G Ninja
        -DKokkos_ROOT=$BUILD_DIR/kokkos/kokkos/install
        -DCMAKE_CXX_COMPILER=$BUILD_DIR/install/bin/clang++
        -DCMAKE_CXX_FLAGS="-DVERIFY -O3 -lm $KOKKOS_CFLAGS"
        ..
    - echo $NINJA
    - $NINJA --version
    - time $NINJA -l `nproc`
    - time ./openacctest
    - echo -e "\e[0Ksection_end:`date +%s`:openacc-performance\r\e[0K"
    #...........................................................................
    # Build and run
    # kokkos-ornl-int-test.git/examples/openacc-performance-multidimensional
    #
    # It can be slow, so we set DSTEP to get just three iterations across a wide
    # range of sizes.  That should be sufficient to check behavior.
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:openacc-performance-multidimensional[collapsed=true]\r\e[0KCheck kokkos-ornl-int-test.git/examples/openacc-performance-multidimensional"
    - cd $BUILD_DIR/kokkos/kokkos-ornl-int-test/examples/openacc-performance-multidimensional
    - mkdir build && cd build
    - echo $CMAKE
    - $CMAKE --version
    - time $CMAKE -G Ninja
        -DKokkos_ROOT=$BUILD_DIR/kokkos/kokkos/install
        -DCMAKE_CXX_COMPILER=$BUILD_DIR/install/bin/clang++
        -DCMAKE_CXX_FLAGS="-DVERIFY -DDSTEP=4500 -O3 -lm $KOKKOS_CFLAGS"
        ..
    - echo $NINJA
    - $NINJA --version
    - time $NINJA -l `nproc`
    - time ./openacctest
    - echo -e "\e[0Ksection_end:`date +%s`:openacc-performance-multidimensional\r\e[0K"
    #...........................................................................
    # Build and run kokkos-ornl-int-test.git/examples/openacc-performance-scan
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:openacc-performance-scan[collapsed=true]\r\e[0KCheck kokkos-ornl-int-test.git/examples/openacc-performance-scan"
    - cd $BUILD_DIR/kokkos/kokkos-ornl-int-test/examples/openacc-performance-scan
    - mkdir build && cd build
    - echo $CMAKE
    - $CMAKE --version
    - time $CMAKE -G Ninja
        -DKokkos_ROOT=$BUILD_DIR/kokkos/kokkos/install
        -DCMAKE_CXX_COMPILER=$BUILD_DIR/install/bin/clang++
        -DCMAKE_CXX_FLAGS="-DVERIFY -O3 -lm $KOKKOS_CFLAGS"
        ..
    - echo $NINJA
    - $NINJA --version
    - time $NINJA -l `nproc`
    - time ./openacctest
    - echo -e "\e[0Ksection_end:`date +%s`:openacc-performance-scan\r\e[0K"
    #...........................................................................
    # Build and run kokkos-ornl-int-test.git/examples/openacc-performance-teams
    #
    # On CPU-only systems, it can be slow and precision isn't as good, so we set
    # DSTEP to get just three iterations across a wide range of sizes, and we
    # increase EPSILON.  That should be sufficient to check basic behavior.
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:openacc-performance-teams[collapsed=true]\r\e[0KCheck kokkos-ornl-int-test.git/examples/openacc-performance-teams"
    - cd $BUILD_DIR/kokkos/kokkos-ornl-int-test/examples/openacc-performance-teams
    - mkdir build && cd build
    - echo $CMAKE
    - $CMAKE --version
    - time $CMAKE -G Ninja
        -DKokkos_ROOT=$BUILD_DIR/kokkos/kokkos/install
        -DCMAKE_CXX_COMPILER=$BUILD_DIR/install/bin/clang++
        -DCMAKE_CXX_FLAGS="-DVERIFY -DDSTEP=4499 -DEPSILON=1e-3 -O3 -lm $KOKKOS_CFLAGS"
        ..
    - echo $NINJA
    - $NINJA --version
    - time $NINJA -l `nproc`
    - time ./openacctest
    - echo -e "\e[0Ksection_end:`date +%s`:openacc-performance-teams\r\e[0K"
    #...........................................................................
    # Build and run kokkos-ornl-int-test.git/examples/stream
    #...........................................................................
    - echo -e "\e[0Ksection_start:`date +%s`:stream[collapsed=true]\r\e[0KCheck kokkos-ornl-int-test.git/examples/stream"
    - cd $BUILD_DIR/kokkos/kokkos-ornl-int-test/examples/stream
    - mkdir build && cd build
    - echo $CMAKE
    - $CMAKE --version
    - time $CMAKE -G Ninja
        -DKokkos_ROOT=$BUILD_DIR/kokkos/kokkos/install
        -DCMAKE_CXX_COMPILER=$BUILD_DIR/install/bin/clang++
        -DCMAKE_CXX_FLAGS="-O3 -lm $KOKKOS_CFLAGS"
        ..
    - echo $NINJA
    - $NINJA --version
    - time $NINJA -l `nproc`
    - time ./stream
    - echo -e "\e[0Ksection_end:`date +%s`:stream\r\e[0K"
  artifacts:
    when: always
    paths: [kokkos-build-log.txt, kokkos-test-log.txt]

leconte (kokkos):
  extends: [.leconte, .kokkos]
  needs:
    - job: leconte (build)
      artifacts: false

leconte-assert (kokkos):
  extends: [.leconte-assert, .kokkos]
  needs:
    - job: leconte-assert (build)
      artifacts: false

oswald (kokkos):
  extends: [.oswald, .kokkos]
  needs:
    - job: oswald (build)
      artifacts: false

oswald-assert (kokkos):
  extends: [.oswald-assert, .kokkos]
  needs:
    - job: oswald-assert (build)
      artifacts: false

explorer (kokkos):
  extends: [.explorer, .kokkos]
  needs:
    - job: explorer (build)
      artifacts: false

explorer-assert (kokkos):
  extends: [.explorer-assert, .kokkos]
  needs:
    - job: explorer-assert (build)
      artifacts: false

milan (kokkos):
  extends: [.milan, .kokkos]
  needs:
    - job: milan (build)
      artifacts: false

milan-assert (kokkos):
  extends: [.milan-assert, .kokkos]
  needs:
    - job: milan-assert (build)
      artifacts: false

debug (kokkos):
  extends: [.debug, .kokkos]
  needs:
    - job: debug (build)
      artifacts: false
