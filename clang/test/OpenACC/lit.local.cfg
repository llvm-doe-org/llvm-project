import re
import subprocess
import lit.formats
from lit.llvm.subst import ToolSubst

def append_dynamic_library_path(name, value):
    sep = ':'
    if name in config.environment:
        config.environment[name] = value + sep + config.environment[name]
    else:
        config.environment[name] = value

# The OpenMP version required by the OpenACC implementation.
config.substitutions.append(('%fopenmp-version', '-fopenmp-version=51'))

if config.has_libatomic:
    config.substitutions.append(('%libatomic', ' -latomic'))

config.substitutions.append(('%acc-version', '202011'))

openmp_dir = config.llvm_obj_root + "/runtimes/runtimes-bins/openmp"
libacc2omp_dir = openmp_dir + "/libacc2omp/src"
libomp_dir = openmp_dir + "/runtime/src"
libomptarget_dir = openmp_dir + "/libomptarget"
config.substitutions.append(('%acc-includes',
                            ('-isystem ' + libacc2omp_dir + \
                             ' -isystem ' + libomp_dir)))
config.substitutions.append(('%acc-libs', '-lacc2omp'))

# Use lit's internal shell to help guarantee test portability.
config.test_format = lit.formats.ShTest(execute_external=False)

# Set up environment to find libraries at run time
append_dynamic_library_path('LD_LIBRARY_PATH', libacc2omp_dir)
append_dynamic_library_path('LD_LIBRARY_PATH', libomp_dir)
append_dynamic_library_path('LD_LIBRARY_PATH', libomptarget_dir)

# Compute available devices.
dev_info = subprocess.run(config.llvm_omp_device_info, check=True,
  stdout=subprocess.PIPE, stderr=subprocess.PIPE, universal_newlines=True,
  env=config.environment).stdout
tgts = {'x86_64-pc-linux-gnu': 'x86',
        'powerpc64le-ibm-linux-gnu': 'powerpc',
        'nvptx64-nvidia-cuda': 'nvptx',
        'amdgcn-amd-amdhsa': 'amdgpu'}
tgt_to_ndevs = {}
for tgt,reg in tgts.items():
    tgt_omp = tgt.split('-')[0]
    if tgt_omp == "powerpc64le":
        tgt_omp = "ppc64le"
    config.substitutions.append(('%run-' + tgt_omp + '-triple', tgt))
    if reg + '-registered-target' in config.available_features:
        ndevs = len(re.findall("omp_device_" + tgt_omp, dev_info))
    else:
        ndevs = 0
    config.substitutions.append(('%run-if-' + tgt_omp, '' if ndevs else ':'))
    if ndevs:
        tgt_to_ndevs[tgt] = ndevs
lit_config.note("Device counts for 'Clang' OpenACC tests: " + str(tgt_to_ndevs))

for i, (key, value) in enumerate(config.substitutions):
    if re.match(r'.*%\\bclang\\b.*', key) != None:
        # Generally, we need to be aware of dead code in our tests, especially
        # because unused static functions might be test cases that are
        # accidentally not invoked.
        value += ' -Werror=unused-function'
        # Make sure the build's libraries are used not the system's.
        value += ' -L ' + libacc2omp_dir
        value += ' -L ' + libomp_dir
        value += ' -L ' + libomptarget_dir
        value += ' --libomptarget-amdgcn-bc-path=' + libomptarget_dir
        value += ' --libomptarget-nvptx-bc-path=' + libomptarget_dir
        config.substitutions[i] = (key, value)

fc = ToolSubst('FileCheck', unresolved='fatal')
# the parent introduced the opposite rule, so we replace it if we see it.
if len(config.substitutions) > 0 and \
       config.substitutions[0] == (fc.regex, \
                                   'FileCheck --allow-unused-prefixes=false'):
    config.substitutions[0] = (
        fc.regex, 'FileCheck --allow-unused-prefixes=true')
else:
    config.substitutions.insert( \
        0, (fc.regex, 'FileCheck --allow-unused-prefixes=true'))
