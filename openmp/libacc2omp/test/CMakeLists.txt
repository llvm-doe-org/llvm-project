##===----------------------------------------------------------------------===##
# 
# Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
# See https://llvm.org/LICENSE.txt for license information.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
# 
##===----------------------------------------------------------------------===##
#
# Build OpenACC runtime test suite.
#
##===----------------------------------------------------------------------===##

set(AUTO_GEN_COMMENT
    "## Autogenerated by libacc2omp configuration.\n# Do not edit!")

# Generate a test suite for compiling for host.
add_openmp_testsuite(check-libacc2omp-host
  "Running libacc2omp tests" ${CMAKE_CURRENT_BINARY_DIR}/host
  DEPENDS acc2omp)
list(APPEND LIBACC2OMP_LIT_TESTSUITES ${CMAKE_CURRENT_BINARY_DIR}/host)
set(CURRENT_TARGET host)
configure_file(lit.site.cfg.in host/lit.site.cfg @ONLY)

# Generate a test suite for compiling per target device type available on the
# current system.
string(REGEX MATCHALL "([^\ ]+\ |[^\ ]+$)" SYSTEM_TARGETS
       "${LIBOMPTARGET_SYSTEM_TARGETS}")
foreach(CURRENT_TARGET IN LISTS SYSTEM_TARGETS)
  string(STRIP "${CURRENT_TARGET}" CURRENT_TARGET)
  if (NOT CURRENT_TARGET MATCHES "-newRTL$")
    add_openmp_testsuite(check-libacc2omp-${CURRENT_TARGET}
      "Running libacc2omp tests" ${CMAKE_CURRENT_BINARY_DIR}/${CURRENT_TARGET}
      DEPENDS acc2omp)
    list(APPEND LIBACC2OMP_LIT_TESTSUITES
         ${CMAKE_CURRENT_BINARY_DIR}/${CURRENT_TARGET})
    configure_file(lit.site.cfg.in ${CURRENT_TARGET}/lit.site.cfg @ONLY)
  endif()
endforeach()

# Generate a test suite that compiles for all target device types available on
# the current system.
if (SYSTEM_TARGETS)
  add_openmp_testsuite(check-libacc2omp-multitarget
    "Running libacc2omp tests" ${CMAKE_CURRENT_BINARY_DIR}/multitarget
    DEPENDS acc2omp)
  list(APPEND LIBACC2OMP_LIT_TESTSUITES ${CMAKE_CURRENT_BINARY_DIR}/multitarget)
  set(CURRENT_TARGET multitarget)
  configure_file(lit.site.cfg.in ${CURRENT_TARGET}/lit.site.cfg @ONLY)
endif()

# Add check-libacc2omp including all above test suites.
add_openmp_testsuite(check-libacc2omp
  "Running libacc2omp tests" ${LIBACC2OMP_LIT_TESTSUITES}
  EXCLUDE_FROM_CHECK_ALL
  DEPENDS acc2omp)
